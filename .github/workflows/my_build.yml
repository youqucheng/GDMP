name: Build GDMP for Windows (Godot 4) - V18 Precision Fix

on:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Enable Long Paths
        run: git config --system core.longpaths true

      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Create Virtual Drive R
        shell: cmd
        run: |
          subst R: .
          R:

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' 

      - name: Install Bazel
        run: choco install bazel

      - name: Install Dependencies
        shell: cmd
        run: |
          R:
          pip install numpy opencv-python

      - name: Run Setup
        shell: cmd
        run: |
          R:
          python setup.py

      # 【核心修复】完善 Mock 系统
      # 这次我们不仅建立目录，还要放入 BUILD 文件，把它们变成合法的 Bazel Package
      - name: Construct Mock Repositories
        shell: powershell
        run: |
          Set-Location R:\
          
          # --- 1. Mock NPM (修复 @bazel/typescript is not a package) ---
          Write-Host "Mocking NPM..."
          New-Item -ItemType Directory -Force "mock_npm/@bazel/typescript"
          
          # 根目录文件
          New-Item -Force "mock_npm/WORKSPACE"
          New-Item -Force "mock_npm/BUILD"
          
          # 关键点：在子目录里也放一个 BUILD 文件，证明它是一个 Package
          New-Item -Force "mock_npm/@bazel/typescript/BUILD"
          # 创建空的 index.bzl 骗过加载
          New-Item -Force "mock_npm/@bazel/typescript/index.bzl"

          # --- 2. Mock Remote Execution (修复 TensorFlow 报错) ---
          Write-Host "Mocking Remote Execution..."
          New-Item -ItemType Directory -Force "mock_remote"
          New-Item -Force "mock_remote/WORKSPACE"
          New-Item -Force "mock_remote/BUILD"
          # 创建空的 remote_execution.bzl
          New-Item -Force "mock_remote/remote_execution.bzl"

          # --- 3. Fix Godot-CPP ---
          Write-Host "Fixing Godot-CPP..."
          New-Item -Force "godot-cpp/WORKSPACE"
          "cc_library(name = 'godot', visibility = ['//visibility:public'])" | Out-File "godot-cpp/BUILD" -Encoding ASCII

      # 【核心修复】重写 WORKSPACE (ASCII 编码，无 BOM)
      # 加入了 local_config_remote_execution 的定义
      - name: Rewrite WORKSPACE File
        shell: powershell
        run: |
          Set-Location R:\
          
          $Header = @"
          workspace(name = "gdmp")

          load("@bazel_tools//tools/build_defs/repo:http.bzl", "http_archive")
          load("@bazel_tools//tools/build_defs/repo:git.bzl", "git_repository")

          # === Local Mocks ===
          local_repository(name = "godot-cpp", path = "godot-cpp")
          local_repository(name = "mediapipe", path = "mediapipe")
          
          # Mocked NPM
          local_repository(name = "npm", path = "mock_npm")
          
          # Mocked Remote Config for TensorFlow
          local_repository(name = "local_config_remote_execution", path = "mock_remote")

          # === External Dependencies ===
          http_archive(
              name = "bazel_skylib",
              urls = ["https://github.com/bazelbuild/bazel-skylib/releases/download/1.4.1/bazel-skylib-1.4.1.tar.gz"],
              sha256 = "b8a1527901774180afc798aeb28c4634bdccf19c4d98e7bdd1ce79d1fe9aaad7",
          )
          
          http_archive(
              name = "rules_license",
              urls = ["https://github.com/bazelbuild/rules_license/releases/download/0.0.4/rules_license-0.0.4.tar.gz"],
              sha256 = "615bc82650f209432be99190204a71a98099195a62931ed50272c1f93f545123",
          )

          http_archive(
              name = "hedron_compile_commands",
              url = "https://github.com/hedronvision/bazel-compile-commands-extractor/archive/1e08f8e0507b6b6b1f4416a9a22cf5c28beaba93.tar.gz",
              strip_prefix = "bazel-compile-commands-extractor-1e08f8e0507b6b6b1f4416a9a22cf5c28beaba93",
          )
          
          http_archive(
              name = "com_google_absl",
              urls = ["https://github.com/abseil/abseil-cpp/archive/refs/tags/20230125.3.tar.gz"],
              strip_prefix = "abseil-cpp-20230125.3",
          )
          
          http_archive(
              name = "org_tensorflow",
              urls = ["https://github.com/tensorflow/tensorflow/archive/refs/tags/v2.12.0.tar.gz"],
              strip_prefix = "tensorflow-2.12.0",
          )
          "@

          # 读取原文件，剔除旧头部
          $OriginalCleaned = Get-Content "WORKSPACE" | Where-Object { $_ -notmatch '^\s*workspace\(' }

          # 合并
          $FinalContent = $Header + "`n" + ($OriginalCleaned -join "`n")
          
          # 强制 ASCII 保存
          Set-Content -Path "WORKSPACE" -Value $FinalContent -Encoding ASCII

          Write-Host "WORKSPACE Rebuilt successfully (ASCII)."

      # 4. 编译
      - name: Build with Bazel
        shell: cmd
        run: |
          R:
          echo Starting Compilation...
          bazel build -c opt --keep_going --define=GODOT=4 --copt=/D_WIN32_WINNT=0x0601 //gdmp:GDMP

      - name: Find and Copy Artifacts
        shell: cmd
        run: |
          R:
          mkdir C:\final_output
          for /r bazel-bin %%i in (gdmp.dll) do copy "%%i" C:\final_output\
          for /r %%i in (gdmp.gdextension) do copy "%%i" C:\final_output\

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: gdmp-windows-godot4-v18-precision
          path: C:\final_output\
