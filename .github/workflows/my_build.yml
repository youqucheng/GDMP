name: Build GDMP for Windows (Godot 4) - V11 Fix WORKSPACE

on:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Enable Long Paths
        run: git config --system core.longpaths true

      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Create Virtual Drive R
        shell: cmd
        run: |
          subst R: .
          R:
          echo Virtual Drive R created

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' 

      - name: Install Bazel
        run: choco install bazel

      - name: Install Dependencies
        shell: cmd
        run: |
          R:
          pip install numpy opencv-python

      # 运行 setup.py 生成 Godot 绑定代码 (这一步还是需要的)
      - name: Run Setup (Bindings)
        shell: cmd
        run: |
          R:
          python setup.py

      # 【核心修复】手动补发“身份证”
      # 既然原脚本没生成，我们就自己创建一个空的 WORKSPACE 文件
      # 这样 Bazel 就会认为它们是合法的代码库了
      - name: Create Missing WORKSPACE Files
        shell: cmd
        run: |
          R:
          echo Creating dummy WORKSPACE for godot-cpp...
          type NUL > godot-cpp\WORKSPACE
          
          echo Creating dummy WORKSPACE for mediapipe...
          type NUL > mediapipe\WORKSPACE
          
          echo Verification:
          if exist godot-cpp\WORKSPACE (echo [OK] godot-cpp\WORKSPACE exists) else (echo [FAIL])

      # 注入主配置文件
      - name: Inject Repository Definitions
        shell: powershell
        run: |
          Set-Location R:\
          
          $ContentToAdd = @"

          # === PATCH START ===
          local_repository(
              name = "mediapipe",
              path = "mediapipe",
          )

          local_repository(
              name = "godot-cpp",
              path = "godot-cpp",
          )

          load("@bazel_tools//tools/build_defs/repo:http.bzl", "http_archive")

          http_archive(
              name = "hedron_compile_commands",
              url = "https://github.com/hedronvision/bazel-compile-commands-extractor/archive/1e08f8e0507b6b6b1f4416a9a22cf5c28beaba93.tar.gz",
              strip_prefix = "bazel-compile-commands-extractor-1e08f8e0507b6b6b1f4416a9a22cf5c28beaba93",
          )
          # === PATCH END ===
          "@

          Add-Content -Path "WORKSPACE" -Value $ContentToAdd

      # 编译
      - name: Build with Bazel
        shell: cmd
        run: |
          R:
          echo Starting Compilation...
          bazel build -c opt --define=GODOT=4 --copt=/D_WIN32_WINNT=0x0601 //gdmp:GDMP

      - name: Find and Copy Artifacts
        shell: cmd
        run: |
          R:
          mkdir C:\final_output
          for /r bazel-bin %%i in (gdmp.dll) do copy "%%i" C:\final_output\
          for /r %%i in (gdmp.gdextension) do copy "%%i" C:\final_output\

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: gdmp-windows-godot4-v11-success
          path: C:\final_output\
