name: Build GDMP for Windows (Godot 4) - V9 Brute Force

on:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Enable Long Paths
        run: git config --system core.longpaths true

      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # 创建 R 盘，解决路径长度问题
      - name: Create Virtual Drive R
        shell: cmd
        run: |
          subst R: .
          R:
          echo Virtual Drive R created

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' 

      - name: Install Bazel
        run: choco install bazel

      - name: Install Dependencies
        shell: cmd
        run: |
          R:
          pip install numpy opencv-python

      # 1. 先运行 setup.py (让它下载必要的 extension_api.json，虽然它配置写得烂，但下载功能我们要用)
      - name: Run Setup (Download APIs only)
        shell: cmd
        run: |
          R:
          python setup.py

      # 2. 【核心赔偿步骤】暴力修复 WORKSPACE
      # 不管 setup.py 写了什么，我们把正确的路径强制追加进去
      - name: Brute Force Patch WORKSPACE
        shell: cmd
        run: |
          R:
          python -c "content = \"\"\"
          
          # 暴力追加依赖定义
          local_repository(
              name = 'mediapipe',
              path = 'mediapipe',
          )
          
          local_repository(
              name = 'godot-cpp',
              path = 'godot-cpp',
          )
          
          load('@bazel_tools//tools/build_defs/repo:http.bzl', 'http_archive')
          http_archive(
              name = 'hedron_compile_commands',
              url = 'https://github.com/hedronvision/bazel-compile-commands-extractor/archive/1e08f8e0507b6b6b1f4416a9a22cf5c28beaba93.tar.gz',
              strip_prefix = 'bazel-compile-commands-extractor-1e08f8e0507b6b6b1f4416a9a22cf5c28beaba93',
          )
          \"\"\"; open('WORKSPACE', 'a').write(content)"
          
          echo [INFO] WORKSPACE patched. Verifying content...
          type WORKSPACE

      # 3. 编译 (目标是 GDMP 大写)
      - name: Build with Bazel
        shell: cmd
        run: |
          R:
          echo Building Target //gdmp:GDMP ...
          bazel build -c opt --define=GODOT=4 --copt=/D_WIN32_WINNT=0x0601 //gdmp:GDMP

      - name: Find and Copy Artifacts
        shell: cmd
        run: |
          R:
          mkdir C:\final_output
          for /r bazel-bin %%i in (gdmp.dll) do copy "%%i" C:\final_output\
          for /r %%i in (gdmp.gdextension) do copy "%%i" C:\final_output\

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: gdmp-windows-godot4-v9-success
          path: C:\final_output\
