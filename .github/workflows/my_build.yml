name: Build GDMP (Official Doc Approach) - V20

on:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      # 1. 基础环境：开启长路径 (MediaPipe 必须项，文档虽没写但这是 Windows 常识)
      - name: Enable Long Paths
        run: git config --system core.longpaths true

      # 2. 拉取代码：必须递归 (recursive)
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # 3. 虚拟盘：这是为了解决 Bazel 在 Windows 下路径过长的唯一方案
      # 即使官方文档没写，在 CI 环境也是必须的
      - name: Create Virtual Drive R
        shell: cmd
        run: |
          subst R: .
          R:

      # 4. Python 环境：文档要求 Python 3
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' 

      # 5. 安装 Bazel：文档要求
      - name: Install Bazel
        run: choco install bazel

      # 6. 安装 Python 依赖：文档要求 numpy 和 opencv
      - name: Install Python Requirements
        shell: cmd
        run: |
          R:
          pip install numpy opencv-python

      # 7. 【关键步骤】运行 setup.py
      # 官方文档的核心：这一步会自动下载 godot-cpp 并生成必要的 json 绑定文件
      # 我们不带任何参数运行，让它使用默认配置
      - name: Run Setup (Generate Bindings)
        shell: cmd
        run: |
          R:
          python setup.py

      # 8. 编译
      # 根据之前的报错明确了目标是 //gdmp:GDMP
      # --copt=/D_WIN32_WINNT=0x0601 是为了兼容 Windows 7+ (常见 Bazel 配置)
      - name: Build with Bazel
        shell: cmd
        run: |
          R:
          echo Starting Official Build Process...
          bazel build -c opt --define=GODOT=4 --copt=/D_WIN32_WINNT=0x0601 //gdmp:GDMP

      # 9. 收集产物
      - name: Find and Copy Artifacts
        shell: cmd
        run: |
          R:
          mkdir C:\final_output
          
          echo Collecting DLL...
          for /r bazel-bin %%i in (gdmp.dll) do copy "%%i" C:\final_output\
          
          echo Collecting GDExtension file...
          for /r %%i in (gdmp.gdextension) do copy "%%i" C:\final_output\

      # 10. 上传
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: gdmp-official-build
          path: C:\final_output\
