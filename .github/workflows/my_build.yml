name: Build GDMP for Windows (Godot 4) - V15 Mock Fix

on:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Enable Long Paths
        run: git config --system core.longpaths true

      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Create Virtual Drive R
        shell: cmd
        run: |
          subst R: .
          R:

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' 

      - name: Install Bazel
        run: choco install bazel

      - name: Install Dependencies
        shell: cmd
        run: |
          R:
          pip install numpy opencv-python

      # 1. 运行 setup.py (获取基础配置)
      - name: Run Setup (Bindings)
        shell: cmd
        run: |
          R:
          python setup.py

      # 2. 【关键修复 A】: 给 Godot-CPP 补上“身份证”和“户口本”
      # 之前的报错说 godot-cpp 没有 BUILD 文件，这里我们手动捏一个
      - name: Fix Godot-CPP
        shell: cmd
        run: |
          R:
          echo Fixing Godot-CPP...
          type NUL > godot-cpp\WORKSPACE
          
          echo cc_library(name = "godot", visibility = ["//visibility:public"]) > godot-cpp\BUILD

      # 3. 【关键修复 B】: 制造一个假的 NPM (Mocking)
      # MediaPipe 吵着要 npm，我们就给它一个空的，骗过依赖检查
      - name: Mock NPM for Windows
        shell: powershell
        run: |
          Set-Location R:\
          New-Item -ItemType Directory -Force -Path "mock_npm"
          New-Item -ItemType Directory -Force -Path "mock_npm/@bazel/typescript"
          
          # 创建空的配置文件，骗过 Bazel
          New-Item -ItemType File -Force -Path "mock_npm/WORKSPACE"
          New-Item -ItemType File -Force -Path "mock_npm/BUILD"
          New-Item -ItemType File -Force -Path "mock_npm/@bazel/typescript/index.bzl"

      # 4. 【关键修复 C】: 手动注入所有缺失的大型依赖 (ABSL, TensorFlow, Skylib)
      - name: Inject Heavy Dependencies
        shell: powershell
        run: |
          Set-Location R:\
          
          $ConfigBlock = @"
          # === PATCH START ===
          
          # 1. 定义本地的假 NPM
          local_repository(
              name = "npm",
              path = "mock_npm",
          )

          # 2. 定义 Godot-CPP 和 MediaPipe 本地路径
          local_repository(name = "godot-cpp", path = "godot-cpp")
          local_repository(name = "mediapipe", path = "mediapipe")

          # 3. 基础工具库 (Skylib & Hedron)
          load("@bazel_tools//tools/build_defs/repo:http.bzl", "http_archive")
          
          http_archive(
              name = "bazel_skylib",
              urls = ["https://github.com/bazelbuild/bazel-skylib/releases/download/1.4.1/bazel-skylib-1.4.1.tar.gz"],
              sha256 = "b8a1527901774180afc798aeb28c4634bdccf19c4d98e7bdd1ce79d1fe9aaad7",
          )

          http_archive(
              name = "hedron_compile_commands",
              url = "https://github.com/hedronvision/bazel-compile-commands-extractor/archive/1e08f8e0507b6b6b1f4416a9a22cf5c28beaba93.tar.gz",
              strip_prefix = "bazel-compile-commands-extractor-1e08f8e0507b6b6b1f4416a9a22cf5c28beaba93",
          )

          # 4. Google Abseil (核心基础库，报错缺这个)
          http_archive(
              name = "com_google_absl",
              urls = ["https://github.com/abseil/abseil-cpp/archive/refs/tags/20230125.3.tar.gz"],
              strip_prefix = "abseil-cpp-20230125.3",
          )

          # 5. TensorFlow (核心AI库，报错缺这个)
          # 注意：这里引用一个轻量级的定义，或者依赖 MediaPipe 内部的定义
          # 为了稳妥，我们使用 MediaPipe 推荐的 http_archive 方式
          http_archive(
              name = "org_tensorflow",
              urls = ["https://github.com/tensorflow/tensorflow/archive/refs/tags/v2.12.0.tar.gz"],
              strip_prefix = "tensorflow-2.12.0",
          )

          # 6. Rules Proto (协议库)
          http_archive(
              name = "rules_proto",
              urls = ["https://github.com/bazelbuild/rules_proto/archive/refs/tags/5.3.0-21.7.tar.gz"],
              strip_prefix = "rules_proto-5.3.0-21.7",
              sha256 = "dc3fb206a2cb344128222763d4061945d33d63c1046f4bc8d8eaabb4f7271d72",
          )

          # === PATCH END ===
          "@
          
          # 覆盖写入 WORKSPACE (我们不再信任原来的文件，直接重写头部)
          # 注意：这里我们保留 setup.py 可能生成的其他内容，追加到后面
          $OriginalContent = Get-Content "WORKSPACE" -Raw
          $FinalContent = $ConfigBlock + "`n" + $OriginalContent
          Set-Content -Path "WORKSPACE" -Value $FinalContent
          
          Write-Host "WORKSPACE Patched. Content Preview:"
          Get-Content WORKSPACE -Head 50

      # 5. 编译
      # 增加 --keep_going 参数，告诉 Bazel 遇到不重要的小错误继续跑，别停！
      - name: Build with Bazel
        shell: cmd
        run: |
          R:
          echo Starting Compilation...
          bazel build -c opt --keep_going --define=GODOT=4 --copt=/D_WIN32_WINNT=0x0601 //gdmp:GDMP

      - name: Find and Copy Artifacts
        shell: cmd
        run: |
          R:
          mkdir C:\final_output
          for /r bazel-bin %%i in (gdmp.dll) do copy "%%i" C:\final_output\
          for /r %%i in (gdmp.gdextension) do copy "%%i" C:\final_output\

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: gdmp-windows-godot4-v15-success
          path: C:\final_output\
