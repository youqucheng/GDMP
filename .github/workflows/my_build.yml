name: Build GDMP for Windows (Godot 4) - V12 Fusion Fix

on:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Enable Long Paths
        run: git config --system core.longpaths true

      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # 1. 虚拟盘策略 (保持，因为真的很有效)
      - name: Create Virtual Drive R
        shell: cmd
        run: |
          subst R: .
          R:

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' 

      - name: Install Bazel
        run: choco install bazel

      - name: Install Dependencies
        shell: cmd
        run: |
          R:
          pip install numpy opencv-python

      # 2. 运行 setup.py 生成 API json 和基础绑定
      - name: Run Setup (Bindings)
        shell: cmd
        run: |
          R:
          python setup.py

      # 3. 手动补发子模块“身份证” (防止 Bazel 找不到路)
      - name: Create Dummy WORKSPACEs
        shell: cmd
        run: |
          R:
          type NUL > godot-cpp\WORKSPACE
          type NUL > mediapipe\WORKSPACE

      # 4. 【核弹级操作】融合 MediaPipe 官方配置
      # 逻辑：读取 mediapipe/WORKSPACE 的所有内容，排除掉 'workspace(' 开头的行（避免命名冲突）
      # 然后追加到我们的主 WORKSPACE 文件中。
      # 这样，Google 定义的 100+ 个依赖瞬间全部生效。
      - name: Fuse MediaPipe Configuration
        shell: powershell
        run: |
          Set-Location R:\
          
          # 1. 定义我们要保留的基础配置
          $BaseConfig = @"
          workspace(name = "gdmp")
          load("@bazel_tools//tools/build_defs/repo:http.bzl", "http_archive")
          load("@bazel_tools//tools/build_defs/repo:git.bzl", "git_repository")

          local_repository(name = "godot-cpp", path = "godot-cpp")
          local_repository(name = "mediapipe", path = "mediapipe")
          "@
          
          # 2. 写入基础配置（覆盖旧文件）
          Set-Content -Path "WORKSPACE" -Value $BaseConfig
          
          # 3. 读取 MediaPipe 的官方配置，过滤掉 'workspace(' 声明
          Write-Host "Reading MediaPipe official configuration..."
          $MediaPipeConfig = Get-Content "mediapipe\WORKSPACE" | Where-Object { $_ -notmatch '^workspace\(' }
          
          # 4. 暴力追加到主文件
          Write-Host "Injecting MediaPipe config..."
          Add-Content -Path "WORKSPACE" -Value "`n# === MEDIAPIPE FUSION START ==="
          Add-Content -Path "WORKSPACE" -Value $MediaPipeConfig
          Add-Content -Path "WORKSPACE" -Value "# === MEDIAPIPE FUSION END ==="
          
          Write-Host "Fusion Complete. WORKSPACE size:"
          (Get-Item WORKSPACE).Length

      # 5. 编译 (GDMP 大写)
      - name: Build with Bazel
        shell: cmd
        run: |
          R:
          echo Starting Compilation with Fused Config...
          bazel build -c opt --define=GODOT=4 --copt=/D_WIN32_WINNT=0x0601 //gdmp:GDMP

      - name: Find and Copy Artifacts
        shell: cmd
        run: |
          R:
          mkdir C:\final_output
          for /r bazel-bin %%i in (gdmp.dll) do copy "%%i" C:\final_output\
          for /r %%i in (gdmp.gdextension) do copy "%%i" C:\final_output\

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: gdmp-windows-godot4-v12-fusion
          path: C:\final_output\
